<!DOCTYPE html>
<html lang="ja">
<head>
  <!--ãƒ†ã‚¹ãƒˆç”¨ã€€å¾Œã§æ¶ˆã™-->
  <meta name="last-updated" content="2026/01/13 14:02">

  <!-- GAS_URL -->
  <script>
    const GAS_URL ='https://script.google.com/macros/s/AKfycbx7cYln7dfJgiZsnP_KbUNl-JS8BcpkXhbJO7f6TIHZ1upl75HfPrzyC09f59OdspzV/exec';
  </script>
  <script>
    // LIFFåˆæœŸåŒ–ã‚’å®Œå…¨ç„¡åŠ¹åŒ– + Mockãƒ¢ãƒ¼ãƒ‰
    window.addEventListener('DOMContentLoaded', function() {
      // LIFF SDKèª­ã¿è¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯
      if (location.port === '5500' || location.hostname === '127.0.0.1' || location.hostname === 'localhost') {
        console.log('ğŸ”§ Live Server é–‹ç™ºãƒ¢ãƒ¼ãƒ‰');
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        const statusDiv = document.createElement('div');
        statusDiv.id = 'dev-status';
        statusDiv.style.cssText = 'background:#00b900;color:white;padding:12px;border-radius:6px;margin:16px 0;text-align:center;font-weight:bold;position:fixed;top:10px;right:10px;z-index:9999;';
        statusDiv.textContent = 'ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆLive Serverï¼‰';
        document.body.insertBefore(statusDiv, document.body.firstChild);
        
        // userIdãƒ¢ãƒƒã‚¯
        const userIdInput = document.getElementById('userId');
        if (userIdInput) {
          userIdInput.value = 'U8f7d7d2a3e38979c0f5636ec968bacc9ï¼ˆè‡ªåˆ†ï¼‰';
          userIdInput.disabled = true;
        }
        
        // é€ä¿¡ãƒœã‚¿ãƒ³ãƒ¢ãƒƒã‚¯
        const submitBtn = document.querySelector('button[type="submit"], input[type="submit"], button');
        if (submitBtn) {
          submitBtn.style.background = '#ff6b35';
          submitBtn.textContent = 'âœ… é€ä¿¡ãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ï¼‰';
          submitBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            statusDiv.textContent = 'ğŸ‰ é€ä¿¡æˆåŠŸï¼GASã«è¨˜éŒ²ã•ã‚Œã¾ã—ãŸ';
            statusDiv.style.background = '#00a300';
            setTimeout(() => {
              statusDiv.textContent = 'ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆLive Serverï¼‰';
              statusDiv.style.background = '#00b900';
            }, 3000);
          };
        }
      }
    }, true); // trueã§ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè¡Œï¼ˆLIFFã‚ˆã‚Šå…ˆã«å‡¦ç†ï¼‰
  </script>


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">


  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <title>æ¬ å¸­ãƒ»é…åˆ»é€£çµ¡</title>
  <link rel="stylesheet" href="css/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>

<body>
  <main class="container">
    <h1>æœ¬ç•ªç’°å¢ƒ</h1>
    <!--ãƒ†ã‚¹ãƒˆç”¨ã€€å¾Œã§æ¶ˆã™-->
    <p id="update-time">æ›´æ–°æ™‚é–“ãƒ»èª­ã¿è¾¼ã¿ä¸­...</p>

    <h3>æ¬ å¸­ãƒ»é…åˆ»é€£çµ¡ãƒ•ã‚©ãƒ¼ãƒ </h3>
    <!--
      <div style="font-size:13px;color:#555;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="userId">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    -->
    <form id="absenceForm" onsubmit="submitAbsence(); return false;">

      <div class="form-field">
        <label for="nextdate" class="required">æ¬ å¸­ãƒ»é…åˆ»æ—¥</label>
        <input type="date" id="nextdate" name="nextdate" required>
      </div>

      <label for="reason" class="required">æ¬ å¸­ãƒ»é…åˆ»ç†ç”±</label>
      <select id="reason" name="reason" required>
        <option value="" selected disabledé¸æŠã—ã¦ãã ã•ã„</option><!--åˆæœŸå€¤-->
        <option value="ä½“èª¿ä¸è‰¯">ä½“èª¿ä¸è‰¯</option>
        <option value="é€šé™¢">é€šé™¢</option>
        <option value="å®¶åº­äº‹æƒ…">å®¶åº­äº‹æƒ…</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>

      <label for="details">è©³ç´°ï¼ˆç—‡çŠ¶ãªã©ï¼‰</label>
      <textarea id="details" name="details" rows="2" placeholder="ç™ºç†±ãƒ»é ­ç—›ãªã©è‡ªç”±è¨˜å…¥"></textarea>

      <label for="medical">é€šé™¢æœ‰ç„¡ãƒ»äºˆå®š</label>
      <select id="medical" name="medical">
        <option value="äºˆå®šãªã—">äºˆå®šãªã—</option>
        <option value="å—è¨ºäºˆå®šã‚ã‚Š">å—è¨ºäºˆå®šã‚ã‚Š</option>
        <option value="å—è¨ºæ¸ˆã¿">å—è¨ºæ¸ˆã¿</option>
      </select>

      <div class="form-field">
        <label for="nextVisitDate" class="required">æ¬¡å›é€šæ‰€äºˆå®šæ—¥</label>
        <input type="date" id="nextVisitDate" name="nextvisit" class="nextDate-input" required>
      </div>
      <div class="form-field">
        <label for="nextVisitTime">é…åˆ»äºˆå®šï¼ˆæ™‚åˆ»ãŒåˆ†ã‹ã‚‹å ´åˆï¼‰</label>
        <input type="time" id="nextVisitTime" name="nexttime" class="time-input">
      </div>
    </form>

<button type="submit" id="sendBtn" onclick="submitAbsence()">é€ä¿¡</button>

<script>
// GAS/LIFFç”¨ã®æ—¢å­˜é–¢æ•°ï¼ˆãã®ã¾ã¾ä¿æŒï¼‰
async function initLiff(){
  await liff.init({ liffId:'2008783538-yHgAa1tC' });
  if(!liff.isLoggedIn()) return liff.login({ redirectUri: location.href });
  const id = liff.getDecodedIDToken().sub;
  document.getElementById('userId').textContent = id.substring(0,20)+'...';
}


async function submitAbsence() {
  try {
    // â˜… FormDataã§nameå±æ€§ã‚’è‡ªå‹•å–å¾— â˜…
    const formData = new FormData(document.getElementById('absenceForm'));
    const params = Object.fromEntries(formData.entries());
    
    // LIFF userIdè¿½åŠ 
    const idToken = liff.getDecodedIDToken();
    params.userId = idToken.sub;
    
    console.log('ğŸ”¥ é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);
    
    // GASé€ä¿¡
    const query = new URLSearchParams(params);
    await fetch(GAS_URL + '?' + query.toString());
    
    // LINEé€šçŸ¥
    await liff.sendMessages([{
      type: 'text',
      text: `ã€æ¬ å¸­é€£çµ¡ã€‘
ç†ç”±: ${params.reason || 'æœªé¸æŠ'}
è©³ç´°: ${params.details || '-'}
é€šé™¢: ${params.medical || 'æœªé¸æŠ'}
æ¬ å¸­æ—¥: ${params.nextdate}
æ¬¡å›äºˆå®š: ${params.nextvisit || '-'} ${params.nexttime || ''}`
    }]);
    
    alert('âœ… é€ä¿¡ã—ã¾ã—ãŸã€‚ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
  } catch (error) {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    alert('âš ï¸ é€ä¿¡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  } finally {
    if (liff.isInClient()) {
      liff.closeWindow();
    } else {
      location.href = 'https://line.me/R/nv/chat';
    }
  }
}
*/
async function submitAbsence() {
  // â˜…å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯ï¼ˆLINE WORKSæœ€é©åŒ–ï¼‰â˜…
  const required = {
    nextdate: 'æ¬ å¸­ãƒ»é…åˆ»æ—¥',
    reason: 'æ¬ å¸­ãƒ»é…åˆ»ç†ç”±', 
    nextVisitDate: 'æ¬¡å›é€šæ‰€äºˆå®šæ—¥'
  };

    for (let [id, label] of Object.entries(required)) {
    const element = document.getElementById(id);
    if (!element.value.trim()) {
      alert(`${label}ã‚’é¸æŠ/å…¥åŠ›ã—ã¦ãã ã•ã„`);
      element.focus();
      element.scrollIntoView({behavior: 'smooth'});
      return;
    }
  }
  
  try {
    const formData = new FormData(document.getElementById('absenceForm'));
    const params = Object.fromEntries(formData.entries());
    
    // LIFF userIdè¿½åŠ ï¼ˆå®‰å…¨å–å¾—ï¼‰
    let userId = 'web-user'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    try {
      const idToken = liff.getDecodedIDToken();
      params.userId = idToken.sub;
    } catch(e) {
      params.userId = userId; // LIFFå¤–å¯¾å¿œ
    }
    
    console.log('ğŸ”¥ é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);
    
    // GASé€ä¿¡ã®ã¿å®Ÿè¡Œ
    const query = new URLSearchParams(params);
    await fetch(GAS_URL + '?' + query.toString());
    
    
    alert('âœ… GASé€ä¿¡å®Œäº†ï¼\nï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼‹LW Boté€šçŸ¥ç¢ºèªï¼‰');
  } catch (error) {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
  } finally {
    // LIFFåˆ¤å®šã‚ã‚Š
    if (typeof liff !== 'undefined' && liff.isInClient()) {
      liff.closeWindow();
    }
  }
}

  

// â˜…Bå‹äº‹æ¥­æ‰€LINE WORKS Botç”¨ï¼ˆä¿®æ­£ç‰ˆï¼‰â˜…
async function sendAbsence() {
  const formData = {
    name: document.querySelector('input[name="name"]').value || 'æœªè¨˜å…¥',
    date: document.querySelector('input[type="date"]').value || 'æœªè¨˜å…¥',
    reason: document.querySelector('textarea[name="reason"]').value || 'ãªã—'
  };
  
  console.log('Boté€ä¿¡ãƒ‡ãƒ¼ã‚¿:', formData);
  
  try {
    const response = await fetch('https://api.worksmobile.com/r/6811052/notify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Bot-Authorization': 'Bearer kd/Z77U9S6lcbsgmbsdovIBEKa0jbD'
      },
      body: JSON.stringify({
        content: {
          type: 'text',
          text: `ğŸ”´æ¬ å¸­é€£çµ¡\nğŸ‘¤${formData.name}\nğŸ“…${formData.date}\nğŸ“${formData.reason}`
        }
      })
    });
    
    console.log('Botãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);
    
    if (response.ok) {
      alert('âœ… Botã«æ¬ å¸­é€£çµ¡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
    } else {
      alert(`âŒ Boté€ä¿¡ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
  } catch (error) {
    console.error('Botã‚¨ãƒ©ãƒ¼:', error);
    alert('âŒ Boté€ä¿¡ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
}

initLiff();
</script>

  <!--ãƒ†ã‚¹ãƒˆï¼šæ™‚é–“è¡¨ç¤ºç”¨(å¾Œã§æ¶ˆã™)-->
    <script>
      // GitHub Pagesæœ€çµ‚æ›´æ–°æ—¥è‡ªå‹•å–å¾—
      document.addEventListener('DOMContentLoaded', function() {
        const updateTime = document.getElementById('update-time');
        if (updateTime) {
          // GitHub Pagesã®ãƒ¡ã‚¿ã‚¿ã‚°ã‹ã‚‰æœ€çµ‚æ›´æ–°å–å¾—
          const meta = document.querySelector('meta[name="last-updated"]');
          if (meta && meta.content) {
            updateTime.textContent = `æœ€çµ‚æ›´æ–°ãƒ»${meta.content}`;
          } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ“ãƒ«ãƒ‰æ—¥æ™‚ï¼ˆæ‰‹å‹•æ›´æ–°ä¸è¦ï¼‰
            const now = new Date(Date.UTC(2026, 0, 9, 11, 10)); // JST+9è€ƒæ…®
            updateTime.textContent = `æœ€çµ‚æ›´æ–°ãƒ»${now.toLocaleString('ja-JP', {timeZone: 'Asia/Tokyo'})}`;
          }
        }
      });
    </script>


  </main>
</body>
</html>
