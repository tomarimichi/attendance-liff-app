<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>æ¬ å¸­é€£çµ¡ãƒ•ã‚©ãƒ¼ãƒ  - UIé–‹ç™ºãƒ¢ãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- LIFF SDKå®Œå…¨å‰Šé™¤ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

</head>
<body>
  <main class="container">
    <h1>æœ¬ç•ªç’°å¢ƒ</h1>
    <!--ãƒ†ã‚¹ãƒˆç”¨ã€€å¾Œã§æ¶ˆã™-->
    <p id="update-time">æ›´æ–°æ™‚é–“ãƒ»èª­ã¿è¾¼ã¿ä¸­...</p>

    <h3>æ¬ å¸­ãƒ»é…åˆ»é€£çµ¡ãƒ•ã‚©ãƒ¼ãƒ </h3>
    <!--
      <div style="font-size:13px;color:#555;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: <span id="userId">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    -->
    <form id="absenceForm" onsubmit="submitAbsence(); return false;">

      <div class="form-field">
        <label class="required">æ¬ å¸­ãƒ»é…åˆ»æ—¥</label>
        <input type="date" id="nextdate" name="nextdate" required>
      </div>

      <label class="required">æ¬ å¸­ãƒ»é…åˆ»ç†ç”±</label>
      <select id="reason" name="reason" required>
        <option value="" selected disabledé¸æŠã—ã¦ãã ã•ã„</option><!--åˆæœŸå€¤-->
        <option value="ä½“èª¿ä¸è‰¯">ä½“èª¿ä¸è‰¯</option>
        <option value="é€šé™¢">é€šé™¢</option>
        <option value="å®¶åº­äº‹æƒ…">å®¶åº­äº‹æƒ…</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>

      <label>è©³ç´°ï¼ˆç—‡çŠ¶ãªã©ï¼‰</label>
      <textarea id="details" name="details" rows="2" placeholder="ç™ºç†±ãƒ»é ­ç—›ãªã©è‡ªç”±è¨˜å…¥"></textarea>

      <label>é€šé™¢æœ‰ç„¡ãƒ»äºˆå®š</label>
      <select id="medical" name="medical">
        <option value="äºˆå®šãªã—">äºˆå®šãªã—</option>
        <option value="å—è¨ºäºˆå®šã‚ã‚Š">å—è¨ºäºˆå®šã‚ã‚Š</option>
        <option value="å—è¨ºæ¸ˆã¿">å—è¨ºæ¸ˆã¿</option>
      </select>

      <div class="form-field">
        <label class="required">æ¬¡å›é€šæ‰€äºˆå®šæ—¥</label>
        <input type="date" id="nextVisitDate" name="nextvisit" class="nextDate-input" required>
      </div>
      <div class="form-field">
        <label>é…åˆ»äºˆå®šï¼ˆæ™‚åˆ»ãŒåˆ†ã‹ã‚‹å ´åˆï¼‰</label>
        <input type="time" id="nextVisitTime" name="nexttime" class="time-input">
      </div>
    </form>

<button type="submit" id="sendBtn" onclick="submitAbsence()">é€ä¿¡</button>

<script>
// GAS/LIFFç”¨ã®æ—¢å­˜é–¢æ•°ï¼ˆãã®ã¾ã¾ä¿æŒï¼‰
async function initLiff(){
  await liff.init({ liffId:'2008783538-yHgAa1tC' });
  if(!liff.isLoggedIn()) return liff.login({ redirectUri: location.href });
  const id = liff.getDecodedIDToken().sub;
  document.getElementById('userId').textContent = id.substring(0,20)+'...';
}
/* ä¸€æ™‚é€€é¿
async function submitAbsence() {
  const idToken = liff.getDecodedIDToken();
  const data = {
    userId: idToken.sub,
    reason: document.getElementById('reason').value,
    details: document.getElementById('details').value,
    medical: document.getElementById('medical').value,
    nextdate: document.getElementById('nextdate').value,
    nexttime: document.getElementById('nextVisitTime').value,
    nextvisit: document.getElementById('nextVisitDate').value
  };

  try {
    const query = new URLSearchParams(data);
    await fetch(GAS_URL + '?' + query.toString());

    await liff.sendMessages([{
      type: 'text',
      text: `ã€æ¬ å¸­é€£çµ¡ã€‘
ç†ç”±: ${data.reason}
è©³ç´°: ${data.details || '-'}
é€šé™¢: ${data.medical}
æ¬ å¸­æ—¥: ${data.nextdate}
æ¬¡å›äºˆå®š: ${data.nextvisit || '-'} ${data.nexttime || ''}`
    }]);

    alert('âœ… é€ä¿¡ã—ã¾ã—ãŸã€‚ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
  } catch (error) {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    alert('âš ï¸ é€ä¿¡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  } finally {
    if (liff.isInClient()) {
      liff.closeWindow();
    } else {
      location.href = 'https://line.me/R/nv/chat';
    }
  }
}
*/
/* 01091049
async function submitAbsence() {
  try {
    // â˜… FormDataã§nameå±æ€§ã‚’è‡ªå‹•å–å¾— â˜…
    const formData = new FormData(document.getElementById('absenceForm'));
    const params = Object.fromEntries(formData.entries());
    
    // LIFF userIdè¿½åŠ 
    const idToken = liff.getDecodedIDToken();
    params.userId = idToken.sub;
    
    console.log('ğŸ”¥ é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);
    
    // GASé€ä¿¡
    const query = new URLSearchParams(params);
    await fetch(GAS_URL + '?' + query.toString());
    
    // LINEé€šçŸ¥
    await liff.sendMessages([{
      type: 'text',
      text: `ã€æ¬ å¸­é€£çµ¡ã€‘
ç†ç”±: ${params.reason || 'æœªé¸æŠ'}
è©³ç´°: ${params.details || '-'}
é€šé™¢: ${params.medical || 'æœªé¸æŠ'}
æ¬ å¸­æ—¥: ${params.nextdate}
æ¬¡å›äºˆå®š: ${params.nextvisit || '-'} ${params.nexttime || ''}`
    }]);
    
    alert('âœ… é€ä¿¡ã—ã¾ã—ãŸã€‚ã”é€£çµ¡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚');
  } catch (error) {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    alert('âš ï¸ é€ä¿¡å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
  } finally {
    if (liff.isInClient()) {
      liff.closeWindow();
    } else {
      location.href = 'https://line.me/R/nv/chat';
    }
  }
}
*/
async function submitAbsence() {
  // â˜…å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯ï¼ˆLINE WORKSæœ€é©åŒ–ï¼‰â˜…
  const required = {
    nextdate: 'æ¬ å¸­ãƒ»é…åˆ»æ—¥',
    reason: 'æ¬ å¸­ãƒ»é…åˆ»ç†ç”±', 
    nextVisitDate: 'æ¬¡å›é€šæ‰€äºˆå®šæ—¥'
  };

    for (let [id, label] of Object.entries(required)) {
    const element = document.getElementById(id);
    if (!element.value.trim()) {
      alert(`${label}ã‚’é¸æŠ/å…¥åŠ›ã—ã¦ãã ã•ã„`);
      element.focus();
      element.scrollIntoView({behavior: 'smooth'});
      return;
    }
  }
  
  try {
    const formData = new FormData(document.getElementById('absenceForm'));
    const params = Object.fromEntries(formData.entries());
    
    // LIFF userIdè¿½åŠ ï¼ˆå®‰å…¨å–å¾—ï¼‰
    let userId = 'web-user'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    try {
      const idToken = liff.getDecodedIDToken();
      params.userId = idToken.sub;
    } catch(e) {
      params.userId = userId; // LIFFå¤–å¯¾å¿œ
    }
    
    console.log('ğŸ”¥ é€ä¿¡ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', params);
    
    // GASé€ä¿¡ã®ã¿å®Ÿè¡Œ
    const query = new URLSearchParams(params);
    await fetch(GAS_URL + '?' + query.toString());
    
    // â˜… LINEé€šçŸ¥ä¸€æ™‚ç„¡åŠ¹åŒ– â˜…
    /*
    await liff.sendMessages([...]);
    */
    
    alert('âœ… GASé€ä¿¡å®Œäº†ï¼\nï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼‹LW Boté€šçŸ¥ç¢ºèªï¼‰');
  } catch (error) {
    console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
    alert('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
  } finally {
    // LIFFåˆ¤å®šã‚ã‚Š
    if (typeof liff !== 'undefined' && liff.isInClient()) {
      liff.closeWindow();
    }
  }
}

  

// â˜…Bå‹äº‹æ¥­æ‰€LINE WORKS Botç”¨ï¼ˆä¿®æ­£ç‰ˆï¼‰â˜…
async function sendAbsence() {
  const formData = {
    name: document.querySelector('input[name="name"]').value || 'æœªè¨˜å…¥',
    date: document.querySelector('input[type="date"]').value || 'æœªè¨˜å…¥',
    reason: document.querySelector('textarea[name="reason"]').value || 'ãªã—'
  };
  
  console.log('Boté€ä¿¡ãƒ‡ãƒ¼ã‚¿:', formData);
  
  try {
    const response = await fetch('https://api.worksmobile.com/r/6811052/notify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Bot-Authorization': 'Bearer kd/Z77U9S6lcbsgmbsdovIBEKa0jbD'
      },
      body: JSON.stringify({
        content: {
          type: 'text',
          text: `ğŸ”´æ¬ å¸­é€£çµ¡\nğŸ‘¤${formData.name}\nğŸ“…${formData.date}\nğŸ“${formData.reason}`
        }
      })
    });
    
    console.log('Botãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response.status);
    
    if (response.ok) {
      alert('âœ… Botã«æ¬ å¸­é€£çµ¡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼');
    } else {
      alert(`âŒ Boté€ä¿¡ã‚¨ãƒ©ãƒ¼: ${response.status}`);
    }
  } catch (error) {
    console.error('Botã‚¨ãƒ©ãƒ¼:', error);
    alert('âŒ Boté€ä¿¡ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
  }
}

initLiff();
</script>

    <!--ãƒ†ã‚¹ãƒˆï¼šæ™‚é–“è¡¨ç¤ºç”¨(å¾Œã§æ¶ˆã™)-->
<script>
  // GitHub Pagesæœ€çµ‚æ›´æ–°æ—¥è‡ªå‹•å–å¾—
  document.addEventListener('DOMContentLoaded', function() {
    con
</html>
